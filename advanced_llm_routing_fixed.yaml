# Advanced LLM Routing with Smart Classification - Fixed YAML
- id: "athena_advanced_llm_routing"
  alias: "Athena Advanced LLM Routing"
  description: "Smart routing: simple device commands to HA, complex commands to LLM"
  trigger:
    - platform: state
      entity_id: input_text.last_voice_command
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state | length > 0 and trigger.to_state.state != 'unknown' }}"
  action:
    - choose:
        # Route simple device commands to basic HA processing
        - conditions:
            - condition: template
              value_template: >-
                {% set cmd = states('input_text.last_voice_command') | lower %}
                {% set simple_cmds = ['turn on', 'turn off', 'lights on', 'lights off', 'open', 'close', 'lock', 'unlock', 'start', 'stop'] %}
                {% set is_device_command = false %}
                {% for simple_cmd in simple_cmds %}
                  {% if simple_cmd in cmd and cmd.split()|length <= 4 %}
                    {% set is_device_command = true %}
                  {% endif %}
                {% endfor %}
                {{ is_device_command }}
          sequence:
            - service: rest_command.athena_llm_simple
              data:
                command: "{{ states('input_text.last_voice_command') }}"
            - service: system_log.write
              data:
                message: "Athena: Routing SIMPLE device command: {{ states('input_text.last_voice_command') }}"
                level: info
      # Route everything else to intelligent LLM processing (default case)
      default:
        - service: rest_command.athena_llm_complex
          data:
            command: "{{ states('input_text.last_voice_command') }}"
        - service: system_log.write
          data:
            message: "Athena: Routing COMPLEX command to LLM: {{ states('input_text.last_voice_command') }}"
            level: info
  mode: queued
  max: 5